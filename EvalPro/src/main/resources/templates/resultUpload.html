<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EvalPro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <!-- Flatpickr CSS and JS for calendar -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        /* Modern CSS Styles */
:root {
    --primary-color: #4a90e2;
    --hover-color: #357abd;
    --background-color: #f8f9fa;
    --text-color: #2c3e50;
    --border-radius: 8px;
    --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--background-color);
    margin: 0;
    padding: 0;
    color: var(--text-color);
}

/* Updated Layout: Right Panel Below Left Panel */
.container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    padding: 20px;
    box-sizing: border-box;
}

/* Left Panel (Form Section) */
.left-panel {
    background-color: #fff;
    padding: 25px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    width: 100%;
    max-width: 800px;
    margin-bottom: 20px;
}

h1, h2 {
    color: var(--primary-color);
    font-weight: 600;
    margin-bottom: 25px;
}

.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-color);
}

select, input[type="text"], .flatpickr-input, input[type="date"] {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #e0e0e0;
    border-radius: var(--border-radius);
    font-size: 16px;
    background-color: #fff;
    transition: border-color 0.3s ease;
}

select:focus, input[type="text"]:focus, .flatpickr-input:focus {
    border-color: var(--primary-color);
    outline: none;
}

/* Right Panel (Table & Upload Section) */
.right-panel {
    background-color: #fff;
    padding: 25px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    width: 100%;
    max-width: 800px;
}

/* Table Styling */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background-color: #fff;
    box-shadow: var(--box-shadow);
    border-radius: var(--border-radius);
    overflow: hidden;
}

th, td {
    border: 1px solid #dee2e6;
    padding: 12px;
    text-align: center;
}

th {
    background-color: var(--primary-color);
    color: white;
    font-weight: 600;
}

tr:nth-child(even) {
    background-color: #f8f9fa;
}

/* File Upload & Buttons */
.file-upload {
    margin-top: 20px;
    position: relative;
}

.custom-file-input {
    display: inline-block;
    padding: 10px 20px;
    background-color: var(--primary-color);
    color: white;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.custom-file-input:hover {
    background-color: var(--hover-color);
}

#upload-file {
    position: absolute;
    left: 0;
    top: 0;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
}

.download-button, .upload-result {
    padding: 10px 20px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 20px;
    width: 100%;
}

.download-button:hover, .upload-result:hover {
    background-color: #218838;
}

.upload-result {
    background-color: var(--primary-color);
}

.upload-result:hover {
    background-color: var(--hover-color);
}

/* Button Container */
.button-container {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.button-container button {
    flex: 1;
}

.disabled {
    pointer-events: none;
    opacity: 0.5;
}

/* Responsive Design */
@media (max-width: 768px) {
    .left-panel, .right-panel {
        max-width: 100%;
    }

    .button-container {
        flex-direction: column;
    }

    .download-button, .upload-result {
        width: 100%;
    }
}

    </style>
</head>
<body>
<div th:replace="sidebar.html ::adminfragment2"></div>
<div th:replace="topbar.html ::adminfragment1"></div>
<section class="flex items-center justify-center min-h-screen">
    <div class="split-container">
        <!-- Left Panel: Form -->
        <div class="left-panel">
            <h1>Academic Details</h1>
            <form id="academic-form">
                <div class="form-group">
                    <label for="publish-date">Publish Date:</label>
                    <input type="date" id="publish-date" name="publishDate" class="flatpickr-input" placeholder="Select Date">
                </div>

                <div class="form-group">
                    <label for="pattern">Pattern:</label>
                    <select id="pattern" name="pattern" class="form-control">
                        <option value="" selected disabled>Select Pattern</option>
                        <option th:each="pattern : ${universityPatternList}"
                                th:value="${pattern.id}"
                                th:text="${pattern.name}">
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="stream">Stream:</label>
                    <select id="stream" name="stream" onchange="loadSemesters()">
                        <option value="" selected disabled>Select Stream</option>
                        <option th:each="stream : ${streamList}"
                                th:value="${stream.id}"
                                th:text="${stream.name}">
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="year">Year:</label>
                    <select id="year" name="year">
                        <option value="" selected disabled>Select Year</option>
                        <option th:each="yeard : ${yearsList}"
                                th:value="${yeard.id}"
                                th:text="${yeard.year}">
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="semester">Semester:</label>
                    <select id="semester" name="sem" class="form-control">
                        <option value="" disabled selected>Select Semester</option>
                    </select>
                </div>
            </form>
        </div>

        <!-- Right Panel: Table and File Upload -->
        <div class="right-panel">
            <h2>Student Marks Table</h2>
            <div class="button-container">
                <button class="download-button" onclick="downloadExcel()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                    </svg>
                    Download Excel
                </button>



                <table id="marks-table" border="1">
                    <thead>
                    <tr>

                        <th>Student ID</th>
                        <th>Mother Name</th>
                        <!--                <th id="subject-list">Subject 1</th>-->
                    </tr>
                    </thead>
                    <tbody>
                    <tr>

                        <td></td>
                        <td></td>
                        <!--                <td>-</td>-->
                    </tr>
                    </tbody>
                </table>




            </div>
            <div class="file-upload">
                <label class="custom-file-input">
                    Choose File
                    <input type="file" id="upload-file" accept=".xlsx, .xls" onchange="updateFileName()">
                </label>
                <span id="file-name">No file selected</span>
            </div>

            <button class="upload-result" id="upload-button" onclick="uploadResult()" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                    <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                </svg>
                Upload Result
            </button>
        </div>
    </div>
</section>

<script>
    function loadSemesters() {
    var streamId = document.getElementById("stream").value;
    var semesterDropdown = document.getElementById("semester");
<!--    var subjectListDiv = document.getElementById("subject-list");-->

    // Clear existing options
    semesterDropdown.innerHTML = '<option value="" disabled selected>Select Semester</option>';
<!--    subjectListDiv.innerHTML = ''; // Clear previous subjects-->

    if (streamId) {
        fetch('/admin/getSemesters?streamId=' + streamId)
            .then(response => response.json())
            .then(data => {
                data.forEach(semester => {
                    let option = document.createElement("option");
                    option.value = semester.id;
                    option.text = semester.name;
                    semesterDropdown.appendChild(option);
                });
            })
            .catch(error => console.error("Error fetching semesters:", error));
    }
}

document.getElementById("semester").addEventListener("change", function () {
    var semesterId = this.value;
    var streamId = document.getElementById("stream").value;
    var table = document.getElementById("marks-table");
    var thead = table.querySelector("thead tr"); // Select table header row
    var tbody = table.querySelector("tbody"); // Select table body

    if (semesterId && streamId) {
        fetch(`/admin/getSubjects?sem_id=${semesterId}&stream_id=${streamId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(subjects => {
                console.log("Fetched Subjects:", subjects);

                if (Array.isArray(subjects) && subjects.length > 0) {
                    //Removing previously added subject columns
                    thead.querySelectorAll(".subject-column").forEach(col => col.remove());
                    tbody.querySelectorAll("tr").forEach(row => {
                        row.querySelectorAll(".subject-column").forEach(td => td.remove());
                    });

                    // appenging new subject headers **AFTER "Mother Name"**
                    subjects.forEach(subject => {
                        let th = document.createElement("th");
                        th.textContent = subject;
                        th.classList.add("subject-column");
                        thead.appendChild(th);
                    });

                    // appending exact number of subject columns in each row
                    tbody.querySelectorAll("tr").forEach(row => {
                        subjects.forEach(() => {
                            let td = document.createElement("td");
                            td.textContent = " ";
                            td.classList.add("subject-column");
                            row.appendChild(td);
                        });
                    });

                } else {
                    console.error("No subjects found.");
                }
            })
            .catch(error => console.error("Error fetching subjects:", error));
    } else {
        console.error("Semester ID or Stream ID is missing.");
    }
});

function downloadExcel() {
            let table = document.getElementById("marks-table");
            let wb = XLSX.utils.table_to_book(table, {sheet: "Sheet1"});
            XLSX.writeFile(wb, "Student_Marks.xlsx");
        }

function uploadResult() {
    let fileInput = document.getElementById("upload-file");
    console.log(fileInput);

    if (!fileInput || !fileInput.files.length) {
        alert("Please select an Excel file to upload.");
        return;
    }

    let file = fileInput.files[0]; // Get the selected file
    let formData = new FormData();
    formData.append("file", file);
    formData.append("pattern", document.getElementById("pattern").value);
    formData.append("stream", document.getElementById("stream").value);
    formData.append("year", document.getElementById("year").value);
    formData.append("sem", document.getElementById("semester").value);
    formData.append("publishDate", document.getElementById("publish-date").value);

    fetch("/admin/uploadExcel", {
        method: "POST",
        body: formData
    })
    .then(response => response.text())
    .then(data => {
        alert("Upload Successful: " + data);
    })
    .catch(error => {
        console.error("Error uploading file:", error);
        alert("File upload failed!");
    });
}

function updateFileName() {
    let fileInput = document.getElementById("upload-file");
    let fileNameSpan = document.getElementById("file-name");
    let uploadButton = document.getElementById("upload-button");


    if (fileInput.files.length > 0) {
        fileNameSpan.textContent = fileInput.files[0].name; // Display selected file name
        uploadButton.classList.remove("disabled"); // Remove 'disabled' class
        uploadButton.removeAttribute("disabled"); // Enable button
    } else {
        fileNameSpan.textContent = "No file selected"; // Reset if no file
        uploadButton.classList.add("disabled"); // Add 'disabled' class
        uploadButton.setAttribute("disabled", "true"); // Disable button
    }
}


</script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.24.0/axios.min.js"/>
</body>
</html>